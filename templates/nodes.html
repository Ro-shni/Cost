{% extends "base.html" %}

{% block title %}Nodes Analysis - Kubernetes Resource Dashboard{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-5">
            <i class="fas fa-server text-primary me-3"></i>
            Nodes Analysis
        </h1>
        <p class="lead text-muted">Detailed analysis of node resource utilization and efficiency</p>
    </div>
</div>

<!-- Search and Filter Section -->
<div class="search-container">
    <div class="row">
        <div class="col-lg-3 col-md-6 mb-3">
            <label for="nodeTypeFilter" class="form-label fw-bold">Node Type</label>
            <select id="nodeTypeFilter" class="form-select">
                <option value="all">All Nodes</option>
                <option value="over_utilized">Over-utilized Nodes</option>
                <option value="imbalanced">Imbalanced Nodes</option>
                <option value="waste">High Waste Nodes</option>
                <option value="bad_actors">Bad Actor Nodes</option>
            </select>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <label for="nodepoolFilter" class="form-label fw-bold">Node Pool</label>
            <select id="nodepoolFilter" class="form-select">
                <option value="">All Node Pools</option>
            </select>
        </div>
        <div class="col-lg-4 col-md-8 mb-3">
            <label for="searchInput" class="form-label fw-bold">Search Nodes</label>
            <input type="text" id="searchInput" class="form-control" placeholder="Search by node name...">
        </div>
        <div class="col-lg-2 col-md-4 mb-3">
            <label class="form-label">&nbsp;</label>
            <button id="searchBtn" class="btn btn-primary w-100">
                <i class="fas fa-search me-1"></i>Search
            </button>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4" id="statsCards">
    <div class="col-lg-3 col-md-6">
        <div class="card text-center border-primary">
            <div class="card-body">
                <h4 class="text-primary" id="totalNodesCount">-</h4>
                <p class="card-text">Total Nodes</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card text-center border-warning">
            <div class="card-body">
                <h4 class="text-warning" id="avgCpuUtil">-</h4>
                <p class="card-text">Avg CPU Utilization</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card text-center border-info">
            <div class="card-body">
                <h4 class="text-info" id="avgMemUtil">-</h4>
                <p class="card-text">Avg Memory Utilization</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card text-center border-success">
            <div class="card-body">
                <h4 class="text-success" id="totalWaste">-</h4>
                <p class="card-text">Total Waste</p>
            </div>
        </div>
    </div>
</div>

<!-- Results Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="fas fa-table me-2"></i>Node Details
        </h5>
        <div>
            <button id="exportBtn" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-download me-1"></i>Export
            </button>
        </div>
    </div>
    <div class="card-body">
        <div id="loadingSpinner" class="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading nodes data...</p>
        </div>
        
        <div id="tableContainer" style="display: none;">
            <table id="nodesTable" class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Node</th>
                        <th>Node Pool</th>
                        <th>Utilization Pattern</th>
                        <th>CPU Util %</th>
                        <th>Memory Util %</th>
                        <th>CPU Wasted</th>
                        <th>Memory Wasted (GB)</th>
                        <th>CPU Over-requested</th>
                        <th>Memory Over-requested (GB)</th>
                        <th>Resource Balance</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        
        <div id="noDataMessage" style="display: none;" class="text-center py-5">
            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No nodes found</h5>
            <p class="text-muted">Try adjusting your search criteria</p>
        </div>
    </div>
</div>

<!-- Node Detail Modal -->
<div class="modal fade" id="nodeDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-server me-2"></i>Node Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="nodeDetailContent">
                    <!-- Content will be loaded dynamically -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let nodesTable;
let currentData = [];

$(document).ready(function() {
    // Initialize DataTable
    nodesTable = $('#nodesTable').DataTable({
        pageLength: 25,
        responsive: true,
        order: [[3, 'desc']], // Sort by CPU utilization by default
        columnDefs: [
            { targets: [3, 4], render: function(data) { return data ? data.toFixed(1) + '%' : '-'; }},
            { targets: [5, 6, 7, 8], render: function(data) { return data ? formatNumber(data) : '-'; }},
            { targets: [2, 9], render: function(data) { return getStatusBadge(data); }},
            { targets: [10], orderable: false }
        ]
    });

    // Load filter options
    loadFilterOptions();
    
    // Load initial data
    loadNodesData();
    
    // Event handlers
    $('#searchBtn').click(function() {
        loadNodesData();
    });
    
    $('#searchInput').keypress(function(e) {
        if (e.which === 13) {
            loadNodesData();
        }
    });
    
    $('#nodeTypeFilter, #nodepoolFilter').change(function() {
        loadNodesData();
    });
    
    // Export functionality
    $('#exportBtn').click(function() {
        exportData();
    });
    
    // Check URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const nodeType = urlParams.get('type');
    if (nodeType) {
        $('#nodeTypeFilter').val(nodeType);
        loadNodesData();
    }
});

function loadFilterOptions() {
    $.get('/api/filters', function(data) {
        if (data.nodepools) {
            const nodepoolSelect = $('#nodepoolFilter');
            data.nodepools.forEach(function(nodepool) {
                nodepoolSelect.append(`<option value="${nodepool}">${nodepool}</option>`);
            });
        }
    });
}

function loadNodesData() {
    $('#loadingSpinner').show();
    $('#tableContainer').hide();
    $('#noDataMessage').hide();
    
    const params = {
        type: $('#nodeTypeFilter').val(),
        search: $('#searchInput').val(),
        nodepool: $('#nodepoolFilter').val()
    };
    
    $.get('/api/nodes', params, function(data) {
        currentData = data.data;
        
        if (data.data.length === 0) {
            $('#loadingSpinner').hide();
            $('#noDataMessage').show();
            updateStats([]);
            return;
        }
        
        // Clear existing data
        nodesTable.clear();
        
        // Add new data
        data.data.forEach(function(node) {
            const actions = `
                <button class="btn btn-sm btn-outline-primary" onclick="showNodeDetails('${node.node}')">
                    <i class="fas fa-eye"></i>
                </button>
            `;
            
            nodesTable.row.add([
                node.node || '-',
                node.nodepool || '-',
                node.utilization_pattern || '-',
                node.cpu_utilization_pct || 0,
                node.mem_utilization_pct || 0,
                node.cpu_unutilized || 0,
                node.mem_unutilized_GB || 0,
                node.cpu_over_requested || 0,
                node.mem_over_requested_GB || 0,
                node.resource_balance || '-',
                actions
            ]);
        });
        
        nodesTable.draw();
        updateStats(data.data);
        
        $('#loadingSpinner').hide();
        $('#tableContainer').show();
        
    }).fail(function() {
        $('#loadingSpinner').hide();
        $('#noDataMessage').show();
        updateStats([]);
    });
}

function updateStats(data) {
    if (data.length === 0) {
        $('#totalNodesCount').text('-');
        $('#avgCpuUtil').text('-');
        $('#avgMemUtil').text('-');
        $('#totalWaste').text('-');
        return;
    }
    
    const totalNodes = data.length;
    const avgCpuUtil = data.reduce((sum, node) => sum + (node.cpu_utilization_pct || 0), 0) / totalNodes;
    const avgMemUtil = data.reduce((sum, node) => sum + (node.mem_utilization_pct || 0), 0) / totalNodes;
    const totalCpuWaste = data.reduce((sum, node) => sum + (node.cpu_unutilized || 0), 0);
    const totalMemWaste = data.reduce((sum, node) => sum + (node.mem_unutilized_GB || 0), 0);
    
    $('#totalNodesCount').text(totalNodes.toLocaleString());
    $('#avgCpuUtil').text(avgCpuUtil.toFixed(1) + '%');
    $('#avgMemUtil').text(avgMemUtil.toFixed(1) + '%');
    $('#totalWaste').text(formatNumber(totalCpuWaste) + ' CPU, ' + formatNumber(totalMemWaste) + ' GB');
}

function showNodeDetails(nodeName) {
    const node = currentData.find(n => n.node === nodeName);
    if (!node) return;
    
    // Load temporal metrics if available
    $.get(`/api/temporal-metrics/${nodeName}`, function(temporalData) {
        let content = `
            <div class="row">
                <div class="col-md-6">
                    <h6 class="fw-bold">Basic Information</h6>
                    <table class="table table-sm">
                        <tr><td><strong>Node Name:</strong></td><td>${node.node}</td></tr>
                        <tr><td><strong>Node Pool:</strong></td><td>${node.nodepool || '-'}</td></tr>
                        <tr><td><strong>Utilization Pattern:</strong></td><td>${getStatusBadge(node.utilization_pattern)}</td></tr>
                        <tr><td><strong>Bad Actor Type:</strong></td><td>
                            <span class="badge ${(temporalData.basic_info?.bad_actor_type === 'Good Actor') ? 'bg-success' : 'bg-danger'}">
                                ${temporalData.basic_info?.bad_actor_type || 'Unknown'}
                            </span>
                        </td></tr>
                        <tr><td><strong>Resource Balance:</strong></td><td>${getStatusBadge(node.resource_balance)}</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6 class="fw-bold">Resource Metrics</h6>
                    <table class="table table-sm">
                        <tr><td><strong>CPU Capacity:</strong></td><td>${formatNumber(node.node_cpu_capacity_cores || 0)} cores</td></tr>
                        <tr><td><strong>Memory Capacity:</strong></td><td>${formatBytes(node.node_mem_capacity_GB || 0)}</td></tr>
                        <tr><td><strong>CPU Allocatable:</strong></td><td>${formatNumber(node.node_cpu_allocatable || 0)} cores</td></tr>
                        <tr><td><strong>Memory Allocatable:</strong></td><td>${formatBytes(node.node_mem_allocatable_GB || 0)}</td></tr>
                        <tr><td><strong>CPU Requests:</strong></td><td>${formatNumber(node.pod_cpu_req_cores || 0)} cores</td></tr>
                        <tr><td><strong>Memory Requests:</strong></td><td>${formatBytes(node.pod_mem_req_GB || 0)}</td></tr>
                    </table>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-6">
                    <h6 class="fw-bold">Current Utilization</h6>
                    <table class="table table-sm">
                        <tr><td><strong>CPU Utilization:</strong></td><td>${(node.cpu_utilization_pct || 0).toFixed(1)}%</td></tr>
                        <tr><td><strong>Memory Utilization:</strong></td><td>${(node.mem_utilization_pct || 0).toFixed(1)}%</td></tr>
                        <tr><td><strong>CPU Wasted:</strong></td><td>${formatNumber(node.cpu_unutilized || 0)} cores</td></tr>
                        <tr><td><strong>Memory Wasted:</strong></td><td>${formatBytes(node.mem_unutilized_GB || 0)}</td></tr>
                        <tr><td><strong>CPU Over-requested:</strong></td><td>${formatNumber(node.cpu_over_requested || 0)} cores</td></tr>
                        <tr><td><strong>Memory Over-requested:</strong></td><td>${formatBytes(node.mem_over_requested_GB || 0)}</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6 class="fw-bold">Waste & Over-utilization</h6>
                    <table class="table table-sm">
                        <tr><td><strong>CPU/Memory Ratio:</strong></td><td>${(node.node_cpu_mem_ratio || 0).toFixed(3)}</td></tr>
                        <tr><td><strong>Pod Ratio:</strong></td><td>${(node.pod_cpu_mem_ratio || 0).toFixed(3)}</td></tr>
                        <tr><td><strong>Ratio Deviation:</strong></td><td>${(node.ratio_deviation || 0).toFixed(2)}x</td></tr>
                        <tr><td><strong>Anomaly Score:</strong></td><td>${(temporalData.temporal_metrics?.temporal_anomaly_score || 0).toFixed(3)}</td></tr>
                    </table>
                </div>
            </div>
        `;
        
        // Add temporal metrics if available
        if (temporalData.temporal_metrics && Object.keys(temporalData.temporal_metrics).length > 0) {
            const tm = temporalData.temporal_metrics;
            content += `
                <div class="row mt-3">
                    <div class="col-12">
                        <h6 class="fw-bold text-primary">📊 Historical Analysis (Temporal Metrics)</h6>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="fw-bold">CPU Historical Metrics</h6>
                        <table class="table table-sm">
                            ${tm.cpu_util_avg !== undefined ? `<tr><td><strong>Average CPU Utilization:</strong></td><td>${tm.cpu_util_avg.toFixed(1)}%</td></tr>` : ''}
                            ${tm.cpu_util_min !== undefined ? `<tr><td><strong>Min CPU Utilization:</strong></td><td>${tm.cpu_util_min.toFixed(1)}%</td></tr>` : ''}
                            ${tm.cpu_util_max !== undefined ? `<tr><td><strong>Max CPU Utilization:</strong></td><td>${tm.cpu_util_max.toFixed(1)}%</td></tr>` : ''}
                            ${tm.cpu_util_std !== undefined ? `<tr><td><strong>CPU Std Deviation:</strong></td><td>${tm.cpu_util_std.toFixed(1)}%</td></tr>` : ''}
                            ${tm.cpu_volatility !== undefined ? `<tr><td><strong>CPU Volatility:</strong></td><td>${tm.cpu_volatility.toFixed(3)}</td></tr>` : ''}
                            ${tm.cpu_trend !== undefined ? `<tr><td><strong>CPU Trend:</strong></td><td>${tm.cpu_trend > 0 ? '📈' : tm.cpu_trend < 0 ? '📉' : '➡️'} ${tm.cpu_trend.toFixed(1)}%</td></tr>` : ''}
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6 class="fw-bold">Memory Historical Metrics</h6>
                        <table class="table table-sm">
                            ${tm.mem_util_avg !== undefined ? `<tr><td><strong>Average Memory Utilization:</strong></td><td>${tm.mem_util_avg.toFixed(1)}%</td></tr>` : ''}
                            ${tm.mem_util_min !== undefined ? `<tr><td><strong>Min Memory Utilization:</strong></td><td>${tm.mem_util_min.toFixed(1)}%</td></tr>` : ''}
                            ${tm.mem_util_max !== undefined ? `<tr><td><strong>Max Memory Utilization:</strong></td><td>${tm.mem_util_max.toFixed(1)}%</td></tr>` : ''}
                            ${tm.mem_util_std !== undefined ? `<tr><td><strong>Memory Std Deviation:</strong></td><td>${tm.mem_util_std.toFixed(1)}%</td></tr>` : ''}
                            ${tm.mem_volatility !== undefined ? `<tr><td><strong>Memory Volatility:</strong></td><td>${tm.mem_volatility.toFixed(3)}</td></tr>` : ''}
                            ${tm.mem_trend !== undefined ? `<tr><td><strong>Memory Trend:</strong></td><td>${tm.mem_trend > 0 ? '📈' : tm.mem_trend < 0 ? '📉' : '➡️'} ${tm.mem_trend.toFixed(1)}%</td></tr>` : ''}
                        </table>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h6 class="fw-bold">Consistency Metrics</h6>
                        <table class="table table-sm">
                            ${tm.cpu_consistency_score !== undefined ? `<tr><td><strong>CPU Consistency Score:</strong></td><td>${tm.cpu_consistency_score.toFixed(2)} ${tm.cpu_consistency_score < 1 ? '✅' : '⚠️'}</td></tr>` : ''}
                            ${tm.mem_consistency_score !== undefined ? `<tr><td><strong>Memory Consistency Score:</strong></td><td>${tm.mem_consistency_score.toFixed(2)} ${tm.mem_consistency_score < 1 ? '✅' : '⚠️'}</td></tr>` : ''}
                            ${tm.observation_count !== undefined ? `<tr><td><strong>Observations:</strong></td><td>${tm.observation_count} timestamps</td></tr>` : ''}
                        </table>
                    </div>
                    <div class="col-md-6">
                        <div class="alert ${(temporalData.basic_info?.bad_actor_type === 'Good Actor') ? 'alert-success' : 'alert-warning'} mb-0">
                            <h6><i class="fas fa-info-circle me-2"></i>Temporal Analysis Result</h6>
                            <p class="mb-1"><strong>Classification:</strong> ${temporalData.basic_info?.bad_actor_type || 'Unknown'}</p>
                            ${tm.temporal_anomaly_score !== undefined ? `<p class="mb-0"><strong>Anomaly Score:</strong> ${tm.temporal_anomaly_score.toFixed(3)}</p>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        $('#nodeDetailContent').html(content);
        $('#nodeDetailModal').modal('show');
        
    }).fail(function() {
        // Fallback to basic node details if temporal data is not available
        const content = `
            <div class="row">
                <div class="col-md-6">
                    <h6 class="fw-bold">Basic Information</h6>
                    <table class="table table-sm">
                        <tr><td><strong>Node Name:</strong></td><td>${node.node}</td></tr>
                        <tr><td><strong>Node Pool:</strong></td><td>${node.nodepool || '-'}</td></tr>
                        <tr><td><strong>Utilization Pattern:</strong></td><td>${getStatusBadge(node.utilization_pattern)}</td></tr>
                        <tr><td><strong>Resource Balance:</strong></td><td>${getStatusBadge(node.resource_balance)}</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6 class="fw-bold">Resource Metrics</h6>
                    <table class="table table-sm">
                        <tr><td><strong>CPU Capacity:</strong></td><td>${formatNumber(node.node_cpu_capacity_cores || 0)} cores</td></tr>
                        <tr><td><strong>Memory Capacity:</strong></td><td>${formatBytes(node.node_mem_capacity_GB || 0)}</td></tr>
                        <tr><td><strong>CPU Utilization:</strong></td><td>${(node.cpu_utilization_pct || 0).toFixed(1)}%</td></tr>
                        <tr><td><strong>Memory Utilization:</strong></td><td>${(node.mem_utilization_pct || 0).toFixed(1)}%</td></tr>
                    </table>
                </div>
            </div>
        `;
        
        $('#nodeDetailContent').html(content);
        $('#nodeDetailModal').modal('show');
    });
}

function exportData() {
    if (currentData.length === 0) {
        alert('No data to export');
        return;
    }
    
    const csv = convertToCSV(currentData);
    downloadCSV(csv, 'nodes_analysis.csv');
}

function convertToCSV(data) {
    if (data.length === 0) return '';
    
    const headers = Object.keys(data[0]);
    const csvContent = [
        headers.join(','),
        ...data.map(row => headers.map(header => {
            const value = row[header];
            return typeof value === 'string' ? `"${value}"` : value;
        }).join(','))
    ].join('\n');
    
    return csvContent;
}

function downloadCSV(csv, filename) {
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.setAttribute('hidden', '');
    a.setAttribute('href', url);
    a.setAttribute('download', filename);
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}
</script>
{% endblock %}
