{% extends "base.html" %}

{% block title %}Pods Analysis - Kubernetes Resource Dashboard{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-5">
            <i class="fas fa-cube text-success me-3"></i>
            Pods Analysis
        </h1>
        <p class="lead text-muted">Resource optimization opportunities at the pod level</p>
    </div>
</div>

<!-- Search and Filter Section -->
<div class="search-container">
    <div class="row">
        <div class="col-lg-2 col-md-6 mb-3">
            <label for="podTypeFilter" class="form-label fw-bold">Pod Type</label>
            <select id="podTypeFilter" class="form-select">
                <option value="all">All Pods</option>
                <option value="cpu_heavy">CPU-Heavy Pods</option>
                <option value="memory_heavy">Memory-Heavy Pods</option>
            </select>
        </div>
        <div class="col-lg-2 col-md-6 mb-3">
            <label for="namespaceFilter" class="form-label fw-bold">Namespace</label>
            <select id="namespaceFilter" class="form-select">
                <option value="">All Namespaces</option>
            </select>
        </div>
        <div class="col-lg-2 col-md-6 mb-3">
            <label for="nodepoolFilter" class="form-label fw-bold">Node Pool</label>
            <select id="nodepoolFilter" class="form-select">
                <option value="">All Node Pools</option>
            </select>
        </div>
        <div class="col-lg-4 col-md-8 mb-3">
            <label for="searchInput" class="form-label fw-bold">Search Pods</label>
            <input type="text" id="searchInput" class="form-control" placeholder="Search by pod name...">
        </div>
        <div class="col-lg-2 col-md-4 mb-3">
            <label class="form-label">&nbsp;</label>
            <button id="searchBtn" class="btn btn-primary w-100">
                <i class="fas fa-search me-1"></i>Search
            </button>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4" id="statsCards">
    <div class="col-lg-3 col-md-6">
        <div class="card text-center border-primary">
            <div class="card-body">
                <h4 class="text-primary" id="totalPodsCount">-</h4>
                <p class="card-text">Total Pods</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card text-center border-danger">
            <div class="card-body">
                <h4 class="text-danger" id="cpuWasteTotal">-</h4>
                <p class="card-text">CPU Waste Potential</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card text-center border-info">
            <div class="card-body">
                <h4 class="text-info" id="memWasteTotal">-</h4>
                <p class="card-text">Memory Waste Potential</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card text-center border-warning">
            <div class="card-body">
                <h4 class="text-warning" id="avgDeviation">-</h4>
                <p class="card-text">Avg Ratio Deviation</p>
            </div>
        </div>
    </div>
</div>

<!-- Resource Pattern Distribution -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Resource Pattern Distribution</h5>
            </div>
            <div class="card-body">
                <div id="patternChart" style="height: 300px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Results Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="fas fa-table me-2"></i>Pod Details
        </h5>
        <div>
            <button id="exportBtn" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-download me-1"></i>Export
            </button>
        </div>
    </div>
    <div class="card-body">
        <div id="loadingSpinner" class="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading pods data...</p>
        </div>
        
        <div id="tableContainer" style="display: none;">
            <table id="podsTable" class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Pod</th>
                        <th>Namespace</th>
                        <th>Node Pool</th>
                        <th>Resource Pattern</th>
                        <th>CPU Request</th>
                        <th>Memory Request (GB)</th>
                        <th>CPU Waste</th>
                        <th>Memory Waste (GB)</th>
                        <th>Ratio Deviation</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        
        <div id="noDataMessage" style="display: none;" class="text-center py-5">
            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No pods found</h5>
            <p class="text-muted">Try adjusting your search criteria</p>
        </div>
    </div>
</div>

<!-- Pod Detail Modal -->
<div class="modal fade" id="podDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cube me-2"></i>Pod Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="podDetailContent">
                    <!-- Content will be loaded dynamically -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recommendations Modal -->
<div class="modal fade" id="recommendationsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-lightbulb me-2"></i>Optimization Recommendations
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="recommendationsContent">
                    <!-- Content will be loaded dynamically -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let podsTable;
let currentData = [];

$(document).ready(function() {
    // Initialize DataTable
    podsTable = $('#podsTable').DataTable({
        pageLength: 25,
        responsive: true,
        order: [[6, 'desc']], // Sort by CPU waste by default
        columnDefs: [
            { targets: [4, 5, 6, 7], render: function(data) { return data ? formatNumber(data) : '-'; }},
            { targets: [8], render: function(data) { return data ? data.toFixed(2) + 'x' : '-'; }},
            { targets: [3], render: function(data) { return getStatusBadge(data); }},
            { targets: [9], orderable: false }
        ]
    });

    // Load filter options
    loadFilterOptions();
    
    // Load initial data
    loadPodsData();
    
    // Event handlers
    $('#searchBtn').click(function() {
        loadPodsData();
    });
    
    $('#searchInput').keypress(function(e) {
        if (e.which === 13) {
            loadPodsData();
        }
    });
    
    $('#podTypeFilter, #namespaceFilter, #nodepoolFilter').change(function() {
        loadPodsData();
    });
    
    // Export functionality
    $('#exportBtn').click(function() {
        exportData();
    });
    
    // Check URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const podType = urlParams.get('type');
    if (podType) {
        $('#podTypeFilter').val(podType);
        loadPodsData();
    }
});

function loadFilterOptions() {
    $.get('/api/filters', function(data) {
        if (data.namespaces) {
            const namespaceSelect = $('#namespaceFilter');
            data.namespaces.forEach(function(namespace) {
                namespaceSelect.append(`<option value="${namespace}">${namespace}</option>`);
            });
        }
        
        if (data.nodepools) {
            const nodepoolSelect = $('#nodepoolFilter');
            data.nodepools.forEach(function(nodepool) {
                nodepoolSelect.append(`<option value="${nodepool}">${nodepool}</option>`);
            });
        }
    });
}

function loadPodsData() {
    $('#loadingSpinner').show();
    $('#tableContainer').hide();
    $('#noDataMessage').hide();
    
    const params = {
        type: $('#podTypeFilter').val(),
        search: $('#searchInput').val(),
        namespace: $('#namespaceFilter').val(),
        nodepool: $('#nodepoolFilter').val()
    };
    
    $.get('/api/pods', params, function(data) {
        currentData = data.data;
        
        if (data.data.length === 0) {
            $('#loadingSpinner').hide();
            $('#noDataMessage').show();
            updateStats([]);
            updateChart([]);
            return;
        }
        
        // Clear existing data
        podsTable.clear();
        
        // Add new data
        data.data.forEach(function(pod) {
            const actions = `
                <button class="btn btn-sm btn-outline-primary me-1" onclick="showPodDetails('${pod.pod}')">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="showRecommendations('${pod.pod}')">
                    <i class="fas fa-lightbulb"></i>
                </button>
            `;
            
            podsTable.row.add([
                pod.pod || '-',
                pod.namespace || '-',
                pod.nodepool || '-',
                pod.resource_pattern || '-',
                pod.pod_cpu_req_cores || 0,
                pod.pod_mem_req_GB || 0,
                pod.pod_cpu_waste || 0,
                pod.pod_mem_waste_GB || 0,
                pod.ratio_deviation || 0,
                actions
            ]);
        });
        
        podsTable.draw();
        updateStats(data.data);
        updateChart(data.data);
        
        $('#loadingSpinner').hide();
        $('#tableContainer').show();
        
    }).fail(function() {
        $('#loadingSpinner').hide();
        $('#noDataMessage').show();
        updateStats([]);
        updateChart([]);
    });
}

function updateStats(data) {
    if (data.length === 0) {
        $('#totalPodsCount').text('-');
        $('#cpuWasteTotal').text('-');
        $('#memWasteTotal').text('-');
        $('#avgDeviation').text('-');
        return;
    }
    
    const totalPods = data.length;
    const totalCpuWaste = data.reduce((sum, pod) => sum + (pod.pod_cpu_waste || 0), 0);
    const totalMemWaste = data.reduce((sum, pod) => sum + (pod.pod_mem_waste_GB || 0), 0);
    const avgDeviation = data.reduce((sum, pod) => sum + (pod.ratio_deviation || 0), 0) / totalPods;
    
    $('#totalPodsCount').text(totalPods.toLocaleString());
    $('#cpuWasteTotal').text(formatNumber(totalCpuWaste) + ' cores');
    $('#memWasteTotal').text(formatNumber(totalMemWaste) + ' GB');
    $('#avgDeviation').text(avgDeviation.toFixed(2) + 'x');
}

function updateChart(data) {
    if (data.length === 0) {
        $('#patternChart').html('<p class="text-center text-muted">No data available</p>');
        return;
    }
    
    // Count resource patterns
    const patterns = {};
    data.forEach(pod => {
        const pattern = pod.resource_pattern || 'Unknown';
        patterns[pattern] = (patterns[pattern] || 0) + 1;
    });
    
    const chartData = [{
        labels: Object.keys(patterns),
        values: Object.values(patterns),
        type: 'pie',
        marker: {
            colors: ['#e74c3c', '#f39c12', '#2ecc71', '#9b59b6', '#1abc9c', '#34495e']
        }
    }];
    
    const layout = {
        title: 'Pod Resource Pattern Distribution',
        margin: { t: 50, b: 50, l: 50, r: 50 }
    };
    
    Plotly.newPlot('patternChart', chartData, layout, {responsive: true});
}

function showPodDetails(podName) {
    const pod = currentData.find(p => p.pod === podName);
    if (!pod) return;
    
    const content = `
        <div class="row">
            <div class="col-md-6">
                <h6 class="fw-bold">Basic Information</h6>
                <table class="table table-sm">
                    <tr><td><strong>Pod Name:</strong></td><td>${pod.pod}</td></tr>
                    <tr><td><strong>Namespace:</strong></td><td>${pod.namespace || '-'}</td></tr>
                    <tr><td><strong>Node Pool:</strong></td><td>${pod.nodepool || '-'}</td></tr>
                    <tr><td><strong>Node:</strong></td><td>${pod.node || '-'}</td></tr>
                    <tr><td><strong>Resource Pattern:</strong></td><td>${getStatusBadge(pod.resource_pattern)}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6 class="fw-bold">Resource Requests</h6>
                <table class="table table-sm">
                    <tr><td><strong>CPU Request:</strong></td><td>${formatNumber(pod.pod_cpu_req_cores || 0)} cores</td></tr>
                    <tr><td><strong>Memory Request:</strong></td><td>${formatBytes(pod.pod_mem_req_GB || 0)}</td></tr>
                    <tr><td><strong>Pod CPU/Memory Ratio:</strong></td><td>${(pod.pod_cpu_mem_ratio || 0).toFixed(3)}</td></tr>
                    <tr><td><strong>Node CPU/Memory Ratio:</strong></td><td>${(pod.node_cpu_mem_ratio || 0).toFixed(3)}</td></tr>
                    <tr><td><strong>Ratio Deviation:</strong></td><td>${(pod.ratio_deviation || 0).toFixed(2)}x</td></tr>
                </table>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-md-6">
                <h6 class="fw-bold">Node Context</h6>
                <table class="table table-sm">
                    <tr><td><strong>Node CPU Capacity:</strong></td><td>${formatNumber(pod.node_cpu_capacity_cores || 0)} cores</td></tr>
                    <tr><td><strong>Node Memory Capacity:</strong></td><td>${formatBytes(pod.node_mem_capacity_GB || 0)}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6 class="fw-bold">Waste Potential</h6>
                <table class="table table-sm">
                    <tr><td><strong>CPU Waste:</strong></td><td class="text-danger">${formatNumber(pod.pod_cpu_waste || 0)} cores</td></tr>
                    <tr><td><strong>Memory Waste:</strong></td><td class="text-danger">${formatBytes(pod.pod_mem_waste_GB || 0)}</td></tr>
                </table>
            </div>
        </div>
    `;
    
    $('#podDetailContent').html(content);
    $('#podDetailModal').modal('show');
}

function showRecommendations(podName) {
    const pod = currentData.find(p => p.pod === podName);
    if (!pod) return;
    
    let recommendations = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>Optimization Recommendations</div>';
    
    if (pod.resource_pattern === 'CPU-heavy' || pod.resource_pattern === 'Severely CPU-heavy') {
        recommendations += `
            <div class="alert alert-warning">
                <h6><i class="fas fa-microchip me-2"></i>CPU-Heavy Pod Detected</h6>
                <p>This pod requests more CPU relative to memory than the node can optimally provide.</p>
                <ul>
                    <li>Consider reducing CPU request to ${formatNumber((pod.pod_mem_req_GB || 0) * (pod.node_cpu_mem_ratio || 0))} cores</li>
                    <li>Or move to a CPU-optimized node pool</li>
                    <li>Current waste: ${formatNumber(pod.pod_cpu_waste || 0)} CPU cores</li>
                </ul>
            </div>
        `;
    } else if (pod.resource_pattern === 'Memory-heavy' || pod.resource_pattern === 'Severely Memory-heavy') {
        recommendations += `
            <div class="alert alert-info">
                <h6><i class="fas fa-memory me-2"></i>Memory-Heavy Pod Detected</h6>
                <p>This pod requests more memory relative to CPU than the node can optimally provide.</p>
                <ul>
                    <li>Consider reducing memory request to ${formatBytes((pod.pod_cpu_req_cores || 0) / (pod.node_cpu_mem_ratio || 1))} GB</li>
                    <li>Or move to a memory-optimized node pool</li>
                    <li>Current waste: ${formatBytes(pod.pod_mem_waste_GB || 0)} memory</li>
                </ul>
            </div>
        `;
    } else {
        recommendations += `
            <div class="alert alert-success">
                <h6><i class="fas fa-check-circle me-2"></i>Well-Balanced Pod</h6>
                <p>This pod has a good resource ratio match with its node. No immediate optimization needed.</p>
            </div>
        `;
    }
    
    // Add general recommendations
    recommendations += `
        <div class="mt-3">
            <h6>General Recommendations:</h6>
            <ul class="list-group">
                <li class="list-group-item">Monitor actual resource usage vs requests using metrics</li>
                <li class="list-group-item">Consider using Vertical Pod Autoscaler (VPA) for automatic optimization</li>
                <li class="list-group-item">Review resource requests periodically based on actual usage patterns</li>
                <li class="list-group-item">Use resource quotas at namespace level to prevent over-allocation</li>
            </ul>
        </div>
    `;
    
    $('#recommendationsContent').html(recommendations);
    $('#recommendationsModal').modal('show');
}

function exportData() {
    if (currentData.length === 0) {
        alert('No data to export');
        return;
    }
    
    const csv = convertToCSV(currentData);
    downloadCSV(csv, 'pods_analysis.csv');
}

function convertToCSV(data) {
    if (data.length === 0) return '';
    
    const headers = Object.keys(data[0]);
    const csvContent = [
        headers.join(','),
        ...data.map(row => headers.map(header => {
            const value = row[header];
            return typeof value === 'string' ? `"${value}"` : value;
        }).join(','))
    ].join('\n');
    
    return csvContent;
}

function downloadCSV(csv, filename) {
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.setAttribute('hidden', '');
    a.setAttribute('href', url);
    a.setAttribute('download', filename);
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}
</script>
{% endblock %}
