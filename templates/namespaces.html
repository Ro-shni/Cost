{% extends "base.html" %}

{% block title %}Namespaces Analysis - Kubernetes Resource Dashboard{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-5">
            <i class="fas fa-folder text-warning me-3"></i>
            Namespaces Analysis
        </h1>
        <p class="lead text-muted">Resource consumption and optimization opportunities by namespace</p>
    </div>
</div>

<!-- Search Section -->
<div class="search-container">
    <div class="row">
        <div class="col-lg-8 col-md-8 mb-3">
            <label for="searchInput" class="form-label fw-bold">Search Namespaces</label>
            <input type="text" id="searchInput" class="form-control" placeholder="Search by namespace name...">
        </div>
        <div class="col-lg-2 col-md-4 mb-3">
            <label class="form-label">&nbsp;</label>
            <button id="searchBtn" class="btn btn-primary w-100">
                <i class="fas fa-search me-1"></i>Search
            </button>
        </div>
        <div class="col-lg-2 col-md-4 mb-3">
            <label class="form-label">&nbsp;</label>
            <button id="resetBtn" class="btn btn-outline-secondary w-100">
                <i class="fas fa-undo me-1"></i>Reset
            </button>
        </div>
    </div>
</div>

<!-- Summary Statistics -->
<div class="row mb-4" id="statsCards">
    <div class="col-lg-3 col-md-6">
        <div class="card text-center border-primary">
            <div class="card-body">
                <h4 class="text-primary" id="totalNamespaces">-</h4>
                <p class="card-text">Total Namespaces</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card text-center border-success">
            <div class="card-body">
                <h4 class="text-success" id="totalPods">-</h4>
                <p class="card-text">Total Pods</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card text-center border-info">
            <div class="card-body">
                <h4 class="text-info" id="totalCpuRequests">-</h4>
                <p class="card-text">Total CPU Requests</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card text-center border-warning">
            <div class="card-body">
                <h4 class="text-warning" id="totalMemRequests">-</h4>
                <p class="card-text">Total Memory Requests</p>
            </div>
        </div>
    </div>
</div>

<!-- Resource Distribution Charts -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Top CPU Consumers</h5>
            </div>
            <div class="card-body">
                <div id="cpuChart" style="height: 400px;"></div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Top Memory Consumers</h5>
            </div>
            <div class="card-body">
                <div id="memChart" style="height: 400px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Waste Potential Charts -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>CPU Waste Potential by Namespace</h5>
            </div>
            <div class="card-body">
                <div id="cpuWasteChart" style="height: 400px;"></div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Memory Waste Potential by Namespace</h5>
            </div>
            <div class="card-body">
                <div id="memWasteChart" style="height: 400px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Results Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="fas fa-table me-2"></i>Namespace Details
        </h5>
        <div>
            <button id="exportBtn" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-download me-1"></i>Export
            </button>
        </div>
    </div>
    <div class="card-body">
        <div id="loadingSpinner" class="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading namespaces data...</p>
        </div>
        
        <div id="tableContainer" style="display: none;">
            <table id="namespacesTable" class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Namespace</th>
                        <th>Pod Count</th>
                        <th>CPU Requests</th>
                        <th>Memory Requests (GB)</th>
                        <th>CPU Waste Potential</th>
                        <th>Memory Waste Potential (GB)</th>
                        <th>Avg CPU per Pod</th>
                        <th>Avg Memory per Pod (GB)</th>
                        <th>Efficiency Score</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        
        <div id="noDataMessage" style="display: none;" class="text-center py-5">
            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No namespaces found</h5>
            <p class="text-muted">Try adjusting your search criteria</p>
        </div>
    </div>
</div>

<!-- Namespace Detail Modal -->
<div class="modal fade" id="namespaceDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-folder me-2"></i>Namespace Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="namespaceDetailContent">
                    <!-- Content will be loaded dynamically -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let namespacesTable;
let currentData = [];

$(document).ready(function() {
    // Initialize DataTable
    namespacesTable = $('#namespacesTable').DataTable({
        pageLength: 25,
        responsive: true,
        order: [[2, 'desc']], // Sort by CPU requests
        columnDefs: [
            { targets: [2, 3, 4, 5, 6, 7], render: function(data) { return data ? formatNumber(data) : '-'; }},
            { targets: [8], render: function(data, type, row) { 
                // Calculate efficiency score based on waste vs requests
                const cpuEfficiency = 1 - ((row[4] || 0) / Math.max(row[2] || 1, 1));
                const memEfficiency = 1 - ((row[5] || 0) / Math.max(row[3] || 1, 1));
                const avgEfficiency = (cpuEfficiency + memEfficiency) / 2;
                const score = Math.max(0, Math.min(100, avgEfficiency * 100));
                
                let badgeClass = 'bg-success';
                if (score < 50) badgeClass = 'bg-danger';
                else if (score < 75) badgeClass = 'bg-warning';
                
                return `<span class="badge ${badgeClass}">${score.toFixed(0)}%</span>`;
            }},
            { targets: [9], orderable: false }
        ]
    });

    // Load initial data
    loadNamespacesData();
    
    // Event handlers
    $('#searchBtn').click(function() {
        loadNamespacesData();
    });
    
    $('#resetBtn').click(function() {
        $('#searchInput').val('');
        loadNamespacesData();
    });
    
    $('#searchInput').keypress(function(e) {
        if (e.which === 13) {
            loadNamespacesData();
        }
    });
    
    // Export functionality
    $('#exportBtn').click(function() {
        exportData();
    });
});

function loadNamespacesData() {
    $('#loadingSpinner').show();
    $('#tableContainer').hide();
    $('#noDataMessage').hide();
    
    const params = {
        search: $('#searchInput').val()
    };
    
    $.get('/api/namespaces', params, function(data) {
        currentData = data.data;
        
        if (data.data.length === 0) {
            $('#loadingSpinner').hide();
            $('#noDataMessage').show();
            updateStats([]);
            updateCharts([]);
            return;
        }
        
        // Clear existing data
        namespacesTable.clear();
        
        // Add new data
        data.data.forEach(function(namespace) {
            const actions = `
                <button class="btn btn-sm btn-outline-primary" onclick="showNamespaceDetails('${namespace.namespace}')">
                    <i class="fas fa-eye"></i>
                </button>
            `;
            
            namespacesTable.row.add([
                namespace.namespace || '-',
                namespace.pod_count || 0,
                namespace.pod_cpu_req_cores || 0,
                namespace.pod_mem_req_GB || 0,
                namespace.pod_cpu_waste || 0,
                namespace.pod_mem_waste_GB || 0,
                namespace.avg_cpu_per_pod || 0,
                namespace.avg_mem_per_pod || 0,
                '', // Efficiency score (calculated in columnDefs)
                actions
            ]);
        });
        
        namespacesTable.draw();
        updateStats(data.data);
        updateCharts(data.data);
        
        $('#loadingSpinner').hide();
        $('#tableContainer').show();
        
    }).fail(function() {
        $('#loadingSpinner').hide();
        $('#noDataMessage').show();
        updateStats([]);
        updateCharts([]);
    });
}

function updateStats(data) {
    if (data.length === 0) {
        $('#totalNamespaces').text('-');
        $('#totalPods').text('-');
        $('#totalCpuRequests').text('-');
        $('#totalMemRequests').text('-');
        return;
    }
    
    const totalNamespaces = data.length;
    const totalPods = data.reduce((sum, ns) => sum + (ns.pod_count || 0), 0);
    const totalCpuRequests = data.reduce((sum, ns) => sum + (ns.pod_cpu_req_cores || 0), 0);
    const totalMemRequests = data.reduce((sum, ns) => sum + (ns.pod_mem_req_GB || 0), 0);
    
    $('#totalNamespaces').text(totalNamespaces.toLocaleString());
    $('#totalPods').text(totalPods.toLocaleString());
    $('#totalCpuRequests').text(formatNumber(totalCpuRequests) + ' cores');
    $('#totalMemRequests').text(formatNumber(totalMemRequests) + ' GB');
}

function updateCharts(data) {
    if (data.length === 0) {
        $('#cpuChart, #memChart, #cpuWasteChart, #memWasteChart').html('<p class="text-center text-muted">No data available</p>');
        return;
    }
    
    // Sort by consumption and take top 15
    const cpuConsumers = data
        .sort((a, b) => (b.pod_cpu_req_cores || 0) - (a.pod_cpu_req_cores || 0))
        .slice(0, 15);
    
    const memConsumers = data
        .sort((a, b) => (b.pod_mem_req_GB || 0) - (a.pod_mem_req_GB || 0))
        .slice(0, 15);
    
    const cpuWasters = data
        .filter(ns => (ns.pod_cpu_waste || 0) > 0)
        .sort((a, b) => (b.pod_cpu_waste || 0) - (a.pod_cpu_waste || 0))
        .slice(0, 15);
    
    const memWasters = data
        .filter(ns => (ns.pod_mem_waste_GB || 0) > 0)
        .sort((a, b) => (b.pod_mem_waste_GB || 0) - (a.pod_mem_waste_GB || 0))
        .slice(0, 15);
    
    // CPU Consumers Chart
    const cpuChart = [{
        x: cpuConsumers.map(ns => ns.pod_cpu_req_cores || 0),
        y: cpuConsumers.map(ns => ns.namespace),
        type: 'bar',
        orientation: 'h',
        marker: { color: '#2ecc71' }
    }];
    
    const cpuLayout = {
        title: 'Top 15 CPU Consuming Namespaces',
        xaxis: { title: 'CPU Cores Requested' },
        margin: { l: 200, r: 50, t: 50, b: 50 }
    };
    
    Plotly.newPlot('cpuChart', cpuChart, cpuLayout, {responsive: true});
    
    // Memory Consumers Chart
    const memChart = [{
        x: memConsumers.map(ns => ns.pod_mem_req_GB || 0),
        y: memConsumers.map(ns => ns.namespace),
        type: 'bar',
        orientation: 'h',
        marker: { color: '#3498db' }
    }];
    
    const memLayout = {
        title: 'Top 15 Memory Consuming Namespaces',
        xaxis: { title: 'Memory (GB) Requested' },
        margin: { l: 200, r: 50, t: 50, b: 50 }
    };
    
    Plotly.newPlot('memChart', memChart, memLayout, {responsive: true});
    
    // CPU Waste Chart
    if (cpuWasters.length > 0) {
        const cpuWasteChart = [{
            x: cpuWasters.map(ns => ns.pod_cpu_waste || 0),
            y: cpuWasters.map(ns => ns.namespace),
            type: 'bar',
            orientation: 'h',
            marker: { color: '#e74c3c' }
        }];
        
        const cpuWasteLayout = {
            title: 'Top 15 CPU Waste Potential by Namespace',
            xaxis: { title: 'CPU Cores Waste Potential' },
            margin: { l: 200, r: 50, t: 50, b: 50 }
        };
        
        Plotly.newPlot('cpuWasteChart', cpuWasteChart, cpuWasteLayout, {responsive: true});
    } else {
        $('#cpuWasteChart').html('<p class="text-center text-muted">No CPU waste detected</p>');
    }
    
    // Memory Waste Chart
    if (memWasters.length > 0) {
        const memWasteChart = [{
            x: memWasters.map(ns => ns.pod_mem_waste_GB || 0),
            y: memWasters.map(ns => ns.namespace),
            type: 'bar',
            orientation: 'h',
            marker: { color: '#f39c12' }
        }];
        
        const memWasteLayout = {
            title: 'Top 15 Memory Waste Potential by Namespace',
            xaxis: { title: 'Memory (GB) Waste Potential' },
            margin: { l: 200, r: 50, t: 50, b: 50 }
        };
        
        Plotly.newPlot('memWasteChart', memWasteChart, memWasteLayout, {responsive: true});
    } else {
        $('#memWasteChart').html('<p class="text-center text-muted">No memory waste detected</p>');
    }
}

function showNamespaceDetails(namespaceName) {
    const namespace = currentData.find(ns => ns.namespace === namespaceName);
    if (!namespace) return;
    
    // Calculate efficiency scores
    const cpuEfficiency = 1 - ((namespace.pod_cpu_waste || 0) / Math.max(namespace.pod_cpu_req_cores || 1, 1));
    const memEfficiency = 1 - ((namespace.pod_mem_waste_GB || 0) / Math.max(namespace.pod_mem_req_GB || 1, 1));
    const avgEfficiency = (cpuEfficiency + memEfficiency) / 2;
    const efficiencyScore = Math.max(0, Math.min(100, avgEfficiency * 100));
    
    const content = `
        <div class="row">
            <div class="col-md-6">
                <h6 class="fw-bold">Basic Information</h6>
                <table class="table table-sm">
                    <tr><td><strong>Namespace:</strong></td><td>${namespace.namespace}</td></tr>
                    <tr><td><strong>Total Pods:</strong></td><td>${namespace.pod_count || 0}</td></tr>
                    <tr><td><strong>Efficiency Score:</strong></td><td>
                        <span class="badge ${efficiencyScore >= 75 ? 'bg-success' : efficiencyScore >= 50 ? 'bg-warning' : 'bg-danger'}">
                            ${efficiencyScore.toFixed(0)}%
                        </span>
                    </td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6 class="fw-bold">Resource Requests</h6>
                <table class="table table-sm">
                    <tr><td><strong>Total CPU Requests:</strong></td><td>${formatNumber(namespace.pod_cpu_req_cores || 0)} cores</td></tr>
                    <tr><td><strong>Total Memory Requests:</strong></td><td>${formatNumber(namespace.pod_mem_req_GB || 0)} GB</td></tr>
                    <tr><td><strong>Avg CPU per Pod:</strong></td><td>${formatNumber(namespace.avg_cpu_per_pod || 0)} cores</td></tr>
                    <tr><td><strong>Avg Memory per Pod:</strong></td><td>${formatNumber(namespace.avg_mem_per_pod || 0)} GB</td></tr>
                </table>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-md-6">
                <h6 class="fw-bold">Optimization Potential</h6>
                <table class="table table-sm">
                    <tr><td><strong>CPU Waste Potential:</strong></td><td class="text-danger">${formatNumber(namespace.pod_cpu_waste || 0)} cores</td></tr>
                    <tr><td><strong>Memory Waste Potential:</strong></td><td class="text-danger">${formatNumber(namespace.pod_mem_waste_GB || 0)} GB</td></tr>
                    <tr><td><strong>CPU Efficiency:</strong></td><td>${(cpuEfficiency * 100).toFixed(1)}%</td></tr>
                    <tr><td><strong>Memory Efficiency:</strong></td><td>${(memEfficiency * 100).toFixed(1)}%</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6 class="fw-bold">Resource Intensity</h6>
                <table class="table table-sm">
                    <tr><td><strong>CPU per Pod Ranking:</strong></td><td>
                        ${namespace.avg_cpu_per_pod > 2 ? '<span class="badge bg-danger">High</span>' : 
                          namespace.avg_cpu_per_pod > 0.5 ? '<span class="badge bg-warning">Medium</span>' : 
                          '<span class="badge bg-success">Low</span>'}
                    </td></tr>
                    <tr><td><strong>Memory per Pod Ranking:</strong></td><td>
                        ${namespace.avg_mem_per_pod > 4 ? '<span class="badge bg-danger">High</span>' : 
                          namespace.avg_mem_per_pod > 1 ? '<span class="badge bg-warning">Medium</span>' : 
                          '<span class="badge bg-success">Low</span>'}
                    </td></tr>
                </table>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <div class="alert alert-info">
                    <h6><i class="fas fa-lightbulb me-2"></i>Optimization Recommendations</h6>
                    <ul class="mb-0">
                        ${(namespace.pod_cpu_waste || 0) > 5 ? '<li>High CPU waste potential - review pod CPU requests and consider right-sizing</li>' : ''}
                        ${(namespace.pod_mem_waste_GB || 0) > 10 ? '<li>High memory waste potential - review pod memory requests</li>' : ''}
                        ${namespace.avg_cpu_per_pod > 2 ? '<li>High CPU usage per pod - consider workload optimization</li>' : ''}
                        ${namespace.avg_mem_per_pod > 4 ? '<li>High memory usage per pod - review memory requirements</li>' : ''}
                        ${efficiencyScore < 50 ? '<li>Low efficiency score - prioritize this namespace for optimization</li>' : ''}
                        <li>Implement resource quotas to prevent over-allocation</li>
                        <li>Use Vertical Pod Autoscaler (VPA) for automatic right-sizing</li>
                        <li>Monitor actual vs requested resources using metrics</li>
                    </ul>
                </div>
            </div>
        </div>
    `;
    
    $('#namespaceDetailContent').html(content);
    $('#namespaceDetailModal').modal('show');
}

function exportData() {
    if (currentData.length === 0) {
        alert('No data to export');
        return;
    }
    
    const csv = convertToCSV(currentData);
    downloadCSV(csv, 'namespaces_analysis.csv');
}

function convertToCSV(data) {
    if (data.length === 0) return '';
    
    const headers = Object.keys(data[0]);
    const csvContent = [
        headers.join(','),
        ...data.map(row => headers.map(header => {
            const value = row[header];
            return typeof value === 'string' ? `"${value}"` : value;
        }).join(','))
    ].join('\n');
    
    return csvContent;
}

function downloadCSV(csv, filename) {
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.setAttribute('hidden', '');
    a.setAttribute('href', url);
    a.setAttribute('download', filename);
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}
</script>
{% endblock %}
